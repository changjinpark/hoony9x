## 놀이의발견
- 2020.01.06 - 2020.02.28

### On-Demand Image Resize 모듈 개발

"놀이의발견"에는 많은 양의 이미지가 AWS S3 Bucket 에 저장이 되어 있으며 이는 AWS CloudFront 를 경유하여 다양한 서비스를 통해 전송이 되고 있습니다. 

그동안은 이미지를 업로드할 때 별도로 용량을 줄이는 과정 없이 원본을 저장하고 있었습니다. 하지만, 회원수가 증가함에 따라 이미지 요청 횟수 역시 상당히 증가하게 되었고 원본 이미지를 계속 보내주다 보니 유저 입장에서도 데이터 소모량이 클 뿐만 아니라 회사 입장에서는 트래픽 비용이 엄청나게 증가하는 문제가 있었습니다. 

저가 작업해야 했던 것은 "Client에서 특정 이미지를 특정 해상도로 요청을 할 경우 그 해상도로 이미지를 중간에 변환을 하여 응답해주도록 기능을 구현" 하는 것이었습니다.

Client 는 CloudFront 에 이미지를 요청하게 됩니다. 캐싱이 된 이미지가 있을 경우 CloudFront 에서 바로 응답을 보내주게 되며, 아닐 경우 S3 Bucket 에 해당 이미지를 요청하게 됩니다.  
그리고 S3 에서 해당 이미지를 응답으로 보내주게 되는데, Lambda@Edge 를 이용하면 이 과정에 Intercept 하여 응답에 변형을 가할 수 있게 됩니다. 따라서 S3 에서 응답으로 온 이미지를 Lambda 에서 받은 후 resize 를 진행하여 CloudFront 로 보내주도록 코드를 작성했습니다.  
AWS Lambda 의 경우 Serverless 서비스이며 요청이 있을 경우에만 잠시 코드가 실행이 되며 실행이 된 시간만큼만 과금이 됩니다. 

구현을 하는 과정에서 여러 가지 제약 사항이 있었습니다. 

우선 AWS 환경과 관련된 제약 사항입니다. 
- 실행 시간 제한이 30초: 이미지의 상태에 따라 변환 시간에 차이가 존재하는데, 실행 시간이 30초를 넘게 되면 AWS 에서 강제로 실행을 중지하게 되므로 반드시 30초 이내에 실행이 종료되도록 해야 함. 
- 변환 결과물의 용량 제한이 1MB: S3에서 온 응답에 변형을 가할 경우 body size가 최대 1MB로 제한되며 1MB 초과 시 초과분은 truncated 됨. 따라서 결과물이 제한 용량을 초과할 경우 다른 방법을 생각해야 하며 본 프로젝트에서는 용량 초과시 해당 이미지를 S3에 업로드 후. 해당 이미지의 링크를 301 Redirect 로 응답을 주는 방식으로 해결. 
- Lambda Package 의 용량은 50MB 를 초과하면 안됨. 

변환 대상은 JPG 와 PNG 파일이었습니다. JPG 의 경우 별 문제가 발생하지 않았지만 PNG 파일을 처리하는 과정을 구현하는 과정에서 여러 가지 문제가 많이 발생했습니다. 아래는 대표적인 사례입니다. 
- 포맷은 PNG 인데 투명 레이어(Alpha Layer) 가 없는 경우. 
- PNG compress level 에 따른 용량 감소대비 소요시간 증가 문제. 
- PNG 파일을 JPG로 변환할 경우 투명 배경의 처리 방법 문제. 